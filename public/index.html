<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PRIDA MOBILE PREMIUM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#001d3d">
    <meta name="background-color" content="#001d3d">

    <script>
    const APP_VERSION = '1.0.5';

    (async () => {
      const savedVersion = localStorage.getItem('app_version');

      if (savedVersion !== APP_VERSION) {
        localStorage.setItem('app_version', APP_VERSION);

        // Hapus service worker lama
        if ('serviceWorker' in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          for (const reg of regs) {
            await reg.unregister();
          }
        }

        // Hapus cache browser
        if ('caches' in window) {
          const keys = await caches.keys();
          await Promise.all(keys.map(k => caches.delete(k)));
        }

        // Reload bersih (AMAN UNTUK APK)
        location.replace(location.href);
      }
    })();
    </script>


    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js');
            });
            navigator.serviceWorker.getRegistrations().then(regs => {
                regs.forEach(reg => reg.update());
            });
        }
    </script>

    <style>
        :root {
            --primary: #001d3d;
            --secondary: #007aff;
            --accent: rgba(255, 255, 255, 0.1);
            --bg: #f8fbff;
            --white: #ffffff;
            --text-dark: #001d3d;
            --text-gray: #6c757d;
            --radius-lg: 28px;
            --radius-md: 12px;
            --shadow: 0 8px 16px rgba(0, 86, 179, 0.05);
            --blue-gradient: linear-gradient(135deg, #001d3d 0%, #003566 100%);
        }

        /* --- BASE RESET --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: var(--bg);
            color: var(--text-dark);
            overflow-x: hidden;
            overscroll-behavior-x: none;
            touch-action: pan-y;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--blue-gradient);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .login-card {
            width: 100%;
            max-width: 380px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: 45px 35px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .login-logo {
            width: 85px;
            height: 85px;
            background: var(--blue-gradient);
            color: white;
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 40px;
            box-shadow: 0 10px 20px rgba(0, 29, 61, 0.3);
        }

        .login-card h2 {
            font-size: 28px;
            font-weight: 800;
            margin-bottom: 8px;
            color: var(--primary);
            letter-spacing: -0.8px;
        }

        .login-card p {
            color: var(--text-gray);
            margin-bottom: 35px;
            font-size: 14px;
        }

        .input-group {
            position: relative;
            margin-bottom: 18px;
        }

        .input-group i {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            opacity: 0.6;
        }

        .input-group input {
            width: 100%;
            padding: 18px 18px 18px 52px;
            border-radius: var(--radius-md);
            border: 1.5px solid #e9ecef;
            background: #f8f9fa;
            font-size: 15px;
            outline: none;
            transition: 0.3s;
        }

        .input-group input:focus {
            border-color: var(--primary);
            background: #fff;
            box-shadow: 0 0 0 4px rgba(0, 86, 179, 0.1);
        }

        .login-btn {
            width: 100%;
            padding: 18px;
            border-radius: var(--radius-md);
            border: none;
            background: var(--blue-gradient);
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 10px;
            box-shadow: 0 8px 15px rgba(0, 29, 61, 0.2);
        }

        /* --- APPBAR & NAVIGATION --- */
        #main-app { display: none; }

        .appbar {
            padding: 10px 20px;
            position: sticky;
            top: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 70px;
            background: var(--primary);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .appbar-left { display: flex; align-items: center; gap: 15px; }
        .appbar-left h3 { color: var(--white); font-weight: 800; font-size: 13px; letter-spacing: -0.5px; }
        .menu-toggle { font-size: 22px; color: var(--white); cursor: pointer; }

        .user-info-container { display: flex; align-items: center; gap: 10px; }
        .text-info { text-align: right; }
        .text-info strong { display: block; color: white; font-size: 12px; line-height: 1; }

        .profile-network {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            margin-top: 3px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 10px;
        }
        .profile-network.online { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .profile-network.offline { background: rgba(248, 113, 113, 0.2); color: #f87171; }

        .avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: white;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .nav-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            background: var(--primary);
            padding-bottom: env(safe-area-inset-bottom, 15px);
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        }

        .bottom-nav { display: flex; height: 65px; align-items: center; justify-content: space-around; }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            color: rgba(255, 255, 255, 0.4);
            text-decoration: none;
            font-size: 10px;
            font-weight: 600;
        }
        .nav-item.active { color: var(--white); }
        .nav-item i { font-size: 18px; }

        /* --- SECTIONS --- */
        .section {
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            height: calc(100vh - 135px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.45s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.25s ease;
            visibility: hidden;
        }
        .section.active { transform: translateX(0); opacity: 1; z-index: 2; visibility: visible; touch-action: pan-y; }
        .section.exit-left { transform: translateX(-30%); opacity: 0; }
        .section.exit-right { transform: translateX(30%); opacity: 0; }

        /* --- SIDEBAR --- */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 29, 61, 0.5);
            z-index: 2000;
            display: none;
            backdrop-filter: blur(4px);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 280px;
            height: 100%;
            background: var(--primary);
            z-index: 2001;
            transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            padding: 40px 20px;
            color: var(--white);
        }
        .sidebar.active { left: 0; box-shadow: 15px 0 35px rgba(0, 0, 0, 0.3); }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            border-radius: 14px;
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.75);
            cursor: pointer;
            transition: 0.25s ease;
        }
        .sidebar-item i { font-size: 16px; width: 20px; text-align: center; }
        .sidebar-item:hover { background: rgba(255, 255, 255, 0.08); color: #fff; }
        .sidebar-item.active { background: var(--secondary); color: #fff; box-shadow: 0 6px 15px rgba(0, 122, 255, 0.35); }

        /* --- UI COMPONENTS --- */
        .section-title { font-size: 15px; font-weight: 800; margin: 25px 15px 15px; color: var(--text-dark); display: flex; align-items: center; gap: 8px; }
        .section-title::after { content: ''; flex: 1; height: 1px; background: #e0e0e0; }

        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px 5px; padding: 0 10px; }
        .menu-card { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: 0.2s; }
        .menu-card:active { transform: scale(0.9); }

        .icon-box {
            width: 52px;
            height: 52px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            margin-bottom: 8px;
            background: var(--white);
            color: #0056b3;
            box-shadow: var(--shadow);
            border: 1px solid rgba(0, 86, 179, 0.05);
        }
        .menu-card span { font-size: 10px; font-weight: 700; color: var(--text-dark); line-height: 1.2; }

        .video-item { background: var(--white); border-radius: var(--radius-md); overflow: hidden; margin: 15px 10px; box-shadow: var(--shadow); }
        .video-thumb { width: 100%; aspect-ratio: 16/9; position: relative; }
        .video-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .video-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 45px;
            height: 45px;
            background: rgba(0, 86, 179, 0.8);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        .video-info { padding: 12px; font-size: 13px; font-weight: 700; }

        /* --- MODAL SYSTEM --- */
        #contentModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 29, 61, 0.6);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: none;
            align-items: flex-end;
            justify-content: center;
        }

        .modal-content {
            width: 100%;
            max-width: 500px;
            background: var(--white);
            border-radius: 28px 28px 0 0;
            max-height: calc(100vh - 120px);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.35s ease-out;
        }

        .modal-header { padding: 20px 24px; flex-shrink: 0; border-bottom: 1px solid #eee; }
        .modal-body { flex: 1; overflow-y: auto; padding: 20px 24px; padding-bottom: calc(100px + env(safe-area-inset-bottom)); }
        #modalBody select, #modalBody input { width: 100%; padding: 14px; margin-top: 10px; border-radius: 12px; border: 1.5px solid #eee; background: #f8f9fa; font-size: 14px; outline: none; }
        #modalBody select:focus { border-color: var(--secondary); }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- OTHER UI --- */
        .swipe-indicator { position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); display: flex; gap: 6px; z-index: 1200; }
        .swipe-dot { width: 6px; height: 6px; border-radius: 50%; background: rgba(0, 0, 0, 0.1); transition: 0.3s; }
        .swipe-dot.active { width: 16px; border-radius: 6px; background: var(--primary); }

        #examTimer {
            position: fixed;
            top: 78px;               /* di bawah appbar */
            right: 16px;
            z-index: 99999;
            background: rgba(0, 29, 61, 0.9);
            color: #fff;
            padding: 6px 12px;
            border-radius: 14px;
            font-size: 12px;
            font-weight: 700;
            display: none;           /* PENTING */
        }

        .toast {
            position: fixed;
            top: 85px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 9999;
        }

        #btnInstall {
            display: none;
            position: fixed;
            left: 50%;
            bottom: 40px;
            transform: translateX(-50%);
            z-index: 99999;
            padding: 18px 36px;
            border: none;
            border-radius: 18px;
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: #ffffff;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.5px;
            box-shadow: 0 10px 25px rgba(45, 43, 124, 0.45);
            cursor: pointer;
        }
        #btnInstall:active { transform: translateX(-50%) scale(0.96); }

        .lulus-box { animation: glow 1.5s infinite; }
        @keyframes glow { 0% { box-shadow: 0 0 0 rgba(22, 163, 74, 0.4); } 50% { box-shadow: 0 0 25px rgba(22, 163, 74, 0.8); } 100% { box-shadow: 0 0 0 rgba(22, 163, 74, 0.4); } }

        .confetti { position: fixed; width: 8px; height: 8px; top: -10px; z-index: 99999; animation: fall linear forwards; }
        @keyframes fall { to { transform: translateY(110vh) rotate(720deg); opacity: 0; } }

        #qrScannerBox { width: 100%; }

        #qrReader { width: 100%; height: 260px; background: black; }

        #qrReader video { width: 100% !important; height: 100% !important; object-fit: cover !important; }

        @media print { body { display: none !important; } }
    </style>
</head>

<body>

    <button id="btnInstall">üì≤ Install Aplikasi</button>

    <div id="examTimer">‚è±Ô∏è 00:00</div>

    <div class="toast" id="toast"></div>

    <div id="login-screen">
        <div class="login-card">
            <div class="login-logo"><i class="fa-solid fa-graduation-cap"></i></div>
            <h2>PRIDA Mobile</h2>
            <p>Solusi Akademik Digital Terpadu</p>
            <div class="input-group">
                <i class="fa-solid fa-circle-user"></i>
                <input type="text" id="usernameInput" placeholder="Nama Pengguna" autocomplete="off">
            </div>
            <div class="input-group">
                <i class="fa-solid fa-shield-halved"></i>
                <input type="password" id="passwordInput" placeholder="Password (12345)">
            </div>
            <button class="login-btn" onclick="handleLogin()">MASUK SEKARANG</button>
        </div>
    </div>

    <div id="main-app">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <div style="margin-bottom: 35px; padding: 0 10px;">
                <div id="mainLogo" style="width: 55px; height: 55px; background: rgba(255,255,255,0.15); border-radius: 16px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                    <i class="fa-solid fa-school-flag" style="color: var(--white); font-size: 24px;"></i>
                </div>
                <h4 style="font-size: 18px; font-weight: 800; color: var(--white);">PRIDA SCHOOL</h4>
                <p style="font-size: 11px; color: rgba(255,255,255,0.5);">Excellence in Technology</p>
            </div>
            <div style="display: flex; flex-direction: column; gap: 4px;">
                <div class="sidebar-item active" onclick="document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));this.classList.add('active');showSection('profil', document.querySelector('.nav-item'));toggleSidebar()">
                    <i class="fa-solid fa-house-user"></i> Beranda Utama
                </div>
                <div class="sidebar-item" onclick="document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));this.classList.add('active');toggleSidebar()">
                    <i class="fa-solid fa-user-gear"></i> Pengaturan
                </div>
                <div class="sidebar-item" onclick="document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));this.classList.add('active');toggleSidebar()">
                    <i class="fa-solid fa-bell"></i> Notifikasi
                </div>
                <div class="sidebar-item" onclick="handleLogout()"><i class="fa-solid fa-power-off"></i> Logout</div>
            </div>
        </div>

        <div class="appbar">
            <div class="appbar-left">
                <i class="fa-solid fa-bars-staggered menu-toggle" onclick="toggleSidebar()"></i>
                <h3>SMKS PGRI 2 KEDONDONG</h3>
            </div>
            <div class="appbar-right">
                <div class="user-info-container">
                    <div class="text-info">
                        <strong id="displayUserName">User</strong>
                        <div id="networkStatus" class="profile-network online">
                            <i class="fa-solid fa-circle" style="font-size: 7px;"></i> Online
                        </div>
                    </div>
                    <label for="fileInput" class="avatar" id="userAvatar">
                        <i class="fa-solid fa-user-tie" id="placeholderIcon" style="color: var(--primary);"></i>
                    </label>
                    <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="previewImage(event)">
                </div>
            </div>
        </div>

        <div class="section active" id="profil">
            <div class="section-title">Kelembagaan</div>
            <div class="menu-grid" id="grid-lembaga">
                <div class="menu-card static-item" onclick="openDynamicContent('Sejarah Lembaga')">
                    <div class="icon-box" style="background: #eef2ff; color: #4338ca;"><i class="fa-solid fa-clock-rotate-left"></i></div>
                    <span>Sejarah Lembaga</span>
                </div>
                <div class="menu-card static-item" onclick="openDynamicContent('Identitas Sekolah')">
                    <div class="icon-box" style="background: #e0f2fe; color: #0369a1;"><i class="fa-solid fa-school"></i></div>
                    <span>Identitas Sekolah</span>
                </div>
                <div class="menu-card static-item" onclick="fetchAndShowPTK()">
                    <div class="icon-box" style="background: #ecfdf5; color: #047857;"><i class="fa-solid fa-chalkboard-user"></i></div>
                    <span>Daftar PTK</span>
                </div>
                <div class="menu-card static-item" onclick="openDynamicContent('Jurusan SMK')">
                    <div class="icon-box" style="background: #fff7ed; color: #b45309;"><i class="fa-solid fa-microchip"></i></div>
                    <span>Jurusan SMK</span>
                </div>
            </div>

            <div class="section-title">Akademik & Siswa</div>
            <div class="menu-grid" id="grid-profil">
                <div class="menu-card static-item" onclick="openExamMenu('Ujian (Exambro)')">
                    <div class="icon-box"><i class="fa-solid fa-laptop-code"></i></div>
                    <span>Ujian (Exambro)</span>
                </div>
                <div class="menu-card static-item" onclick="openDynamicContent('Tracer Alumni')">
                    <div class="icon-box"><i class="fa-solid fa-location-dot"></i></div>
                    <span>Tracer Alumni</span>
                </div>
                <div class="menu-card static-item" onclick="openPengumuman()">
                    <div class="icon-box"><i class="fa-solid fa-bullhorn"></i></div>
                    <span>Pengumuman</span>
                </div>
            </div>
            
            <div class="section-title">Game Edukasi</div>
            <div class="menu-grid" id="grid-game"></div>
        </div>

        <div class="section" id="layanan">
            <div class="section-title">Layanan Publik</div>
            <div class="menu-grid" id="grid-layanan"></div>
        </div>

        <div class="section" id="literasi">
            <div class="section-title">Literasi Digital</div>
            <div class="menu-grid" id="grid-literasi"></div>
        </div>

        <div class="section" id="media">
            <div class="section-title">Media Sosial</div>
            <div class="menu-grid" id="grid-media"></div>
            <div class="section-title">Galeri Video</div>
            <div class="video-list" id="video-profil"></div>
        </div>

        <div class="swipe-indicator" id="swipeIndicator">
            <div class="swipe-dot active"></div>
            <div class="swipe-dot"></div>
            <div class="swipe-dot"></div>
            <div class="swipe-dot"></div>
        </div>

        <div class="nav-wrapper">
            <div class="bottom-nav">
                <a href="#" class="nav-item active" onclick="showSection('profil', this)"><i class="fa-solid fa-house"></i><span>Beranda</span></a>
                <a href="#" class="nav-item" onclick="showSection('layanan', this)"><i class="fa-solid fa-briefcase"></i><span>Layanan</span></a>
                <a href="#" class="nav-item" onclick="showSection('literasi', this)"><i class="fa-solid fa-book-open"></i><span>Literasi</span></a>
                <a href="#" class="nav-item" onclick="showSection('media', this)"><i class="fa-solid fa-at"></i><span>Media</span></a>
            </div>
        </div>
    </div>

    <div id="contentModal" onclick="if(event.target==this) closeModal()">
        <div class="modal-content">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="modalTitle" style="font-size: 18px; color: var(--primary);">Judul Konten</h2>
                <div class="close-modal" onclick="closeModal()" style="cursor:pointer; font-size: 20px;"><i class="fa-solid fa-xmark"></i></div>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script>
        // --- CONSTANTS & DATA ---
        const KELULUSAN_API = 'https://script.google.com/macros/s/AKfycbwE4oaM8yqhsHdyL6aEA4b0y-Z_V-UBpVw7RsJg0oBQeouffCS1W8yEORXBPnE4u7oHyg/exec';
        const API_URL = 'https://script.google.com/macros/s/AKfycbzdUXE8vqAH7g2wa-XnvQWZm1-4cXxMlOjlxsUAufOhjx8OcMfcYe2U8OTa_nKxmsxu/exec';
        const PTK_API_URL = 'https://script.google.com/macros/s/AKfycbwvjXmZX0lRmFifHixi1WTvxc2V5kmbLSQrkmXcLutEicV_UeTqzq1C2zQk6ZLKTVRg/exec';
        const UJIAN_API_URL = 'https://script.google.com/macros/s/AKfycbxUHb3xhYk1w47vDI-iidkLcqLgQeldIgsYhNnfLAdDnsfVtPW4HjD7vLznmrB3EOaG/exec';


        const DYNAMIC_DATA = {
            'Sejarah Lembaga': `
                <p><b>Pendirian SMK PGRI 2 Kedondong</b> dilatarbelakangi oleh kondisi di Kecamatan Kedondong dan sekitarnya (Way Lima, Way Khilau, Padang Cermin Kabupaten Lampung Selatan‚Äîsekarang menjadi Kabupaten Pesawaran‚Äîdan Kecamatan Pardasuka Kabupaten Tanggamus) yang pada saat itu belum memiliki Sekolah Menengah Kejuruan (SMK) bidang Teknologi.</p><br>
                <p>SMK PGRI 2 Kedondong didirikan oleh panitia yang dimotori oleh DR. Andi Munandar, M.M., M.Si. pada tahun 2003. Sekolah ini langsung menerima siswa baru angkatan pertama pada tahun pelajaran 2003/2004 berdasarkan Surat Keputusan Pengurus Yayasan Pembina Lembaga Pendidikan Persatuan Guru Republik Indonesia (YPLP-PGRI) Nomor: 24/C/YPLP-PGRI/V/2004 tertanggal 22 Mei 2004.</p><br>
                <p>Izin operasional sekolah diterbitkan dengan Nomor: 42.5/966/11.2/2006 pada tanggal 24 Februari 2006 oleh Kepala Dinas Pendidikan Kabupaten Lampung Selatan. Sekolah ini berdiri di atas tanah seluas 8.000 m¬≤ milik Drs. Hi. Aminullah Ihsan.</p><br>
                <p>Berdasarkan Undang-Undang Nomor 33 Tahun 2007, wilayah ini resmi menjadi bagian dari Kabupaten Pesawaran. Peresmian pembentukan Kabupaten Pesawaran dilakukan pada 2 November 2007 oleh Mendagri atas nama Presiden Republik Indonesia.</p>`,

            'Identitas Sekolah': `
                <div style="line-height: 1.6;">
                    <h3 style="margin-bottom: 15px;">A. IDENTITAS SEKOLAH</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr><td style="width: 140px; padding: 5px 0;">Nama Sekolah</td><td style="width: 10px;">:</td><td><b>SMKS PGRI 2 KEDONDONG</b></td></tr>
                        <tr><td style="padding: 5px 0;">NPSN</td><td>:</td><td>10811003</td></tr>
                        <tr><td style="padding: 5px 0;">Jenjang</td><td>:</td><td>SMK</td></tr>
                        <tr><td style="padding: 5px 0;">Status</td><td>:</td><td>Swasta</td></tr>
                        <tr><td style="padding: 5px 0; vertical-align: top;">Alamat</td><td style="vertical-align: top;">:</td><td>JL. TRITURA KEDONDONG</td></tr>
                        <tr><td style="padding: 5px 0;">RT / RW</td><td>:</td><td>1 / 1</td></tr>
                        <tr><td style="padding: 5px 0;">Kode Pos</td><td>:</td><td>35381</td></tr>
                        <tr><td style="padding: 5px 0;">Kelurahan</td><td>:</td><td>Kedondong</td></tr>
                        <tr><td style="padding: 5px 0;">Kecamatan</td><td>:</td><td>Kec. Kedondong</td></tr>
                        <tr><td style="padding: 5px 0;">Kabupaten</td><td>:</td><td>Kab. Pesawaran</td></tr>
                        <tr><td style="padding: 5px 0;">Provinsi</td><td>:</td><td>Prov. Lampung</td></tr>
                    </table>
                </div>`,

            'Jurusan SMK': `
                <p>Tersedia 6 Jurusan Unggulan:</p>
                <ul style="padding-left: 20px; margin-top: 10px;">
                    <li>TKR (Teknik Kendaraan Ringan)</li>
                    <li>TSM (Teknik Sepeda Motor)</li>
                    <li>TKJ (Teknik Komputer dan Jaringan)</li>
                    <li>TAV (Teknik Audio Video)</li>
                    <li>BD (Bisnis Digital)</li>
                    <li>LPS (Layanan Perbankan Syariah)</li>
                </ul>`
        };

        let ujianData = [];
        let ujianSedangBerjalan = false;
        let ujianAktif = null;
        let examEndTime = 0;
        let examTimerInterval = null;
        let html5Qr = null;
        let currentTabIndex = 0;
        const sectionIds = ['profil', 'layanan', 'literasi', 'media'];

        // --- AUTH SYSTEM ---
        function handleLogin() {
            const user = document.getElementById('usernameInput').value;
            const pass = document.getElementById('passwordInput').value;
            if (user.trim() !== "" && pass === "12345") {
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('currentUserName', user);
                initApp();
            } else {
                alert("Nama pengguna atau password salah");
            }
        }

        function handleLogout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('currentUserName');
            location.reload();
        }

        function initApp() {
            if (localStorage.getItem('isLoggedIn') === 'true') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'block';
                document.getElementById('displayUserName').innerText = localStorage.getItem('currentUserName');
                const savedAvatar = localStorage.getItem('userProfileAvatar');
                if (savedAvatar) updateAvatarUI(savedAvatar);
                fetchSpreadsheetData();
                updateNetwork();
            }
        }

        // --- FETCHING DATA ---
        async function fetchSpreadsheetData() {
            try {
                const r = await fetch(API_URL);
                const data = await r.json();
                const gridIds = ['grid-lembaga', 'grid-profil', 'grid-game', 'grid-layanan', 'grid-literasi', 'grid-media'];
                const staticItems = {};
                
                gridIds.forEach(id => {
                    const container = document.getElementById(id);
                    if (container) {
                        staticItems[id] = Array.from(container.querySelectorAll('.static-item'));
                        container.innerHTML = '';
                    }
                });

                gridIds.forEach(id => {
                    const container = document.getElementById(id);
                    if (container && staticItems[id]) {
                        staticItems[id].forEach(item => container.appendChild(item));
                    }
                });

                Object.keys(data).forEach(key => {
                    const item = data[key];
                    const sec = item.SectionID ? item.SectionID.toLowerCase().trim() : "";
                    const targetGridId = `grid-${sec}`;

                    if (item.Title === 'Logo Sekolah' && item.Url) {
                        document.getElementById('mainLogo').innerHTML = `<img src="${item.Url}" style="width:100%; padding:8px; object-fit:contain;">`;
                        return;
                    }

                    const container = document.getElementById(targetGridId);
                    if (container) {
                        const card = document.createElement('div');
                        card.className = 'menu-card';
                        card.innerHTML = `<div class="icon-box"><i class="${item.Icon || 'fa-solid fa-link'}"></i></div><span>${item.Title || key}</span>`;
                        card.onclick = () => item.Url ? window.open(item.Url, '_blank') : openModal(item.Title, "Konten belum tersedia.");
                        container.appendChild(card);
                    }

                    if (item.Thumbnail && item.Thumbnail.startsWith('http')) {
                        const videoList = document.getElementById('video-profil');
                        if (videoList) {
                            const v = document.createElement('div');
                            v.className = 'video-item';
                            v.innerHTML = `<div class="video-thumb"><img src="${item.Thumbnail}"><div class="video-play-btn"><i class="fa-solid fa-play"></i></div></div><div class="video-info">${item.Title}</div>`;
                            v.onclick = () => window.open(item.Url, '_blank');
                            videoList.appendChild(v);
                        }
                    }
                });
            } catch (e) {
                console.error("Error loading data", e);
                showToast("Gagal memuat data dari server.");
            }
        }

        async function fetchJadwalUjian() {
            try {
                const res = await fetch(UJIAN_API_URL);
                ujianData = await res.json();
            } catch (e) { console.error("Error loading exam schedule", e); }
        }

        async function fetchAndShowPTK() {
            openModal('Daftar PTK', 'Memuat data guru...');
            try {
                const response = await fetch(PTK_API_URL);
                const dataGuru = await response.json();
                let html = '<div style="display:grid; gap:10px;">';
                dataGuru.forEach(guru => {
                    html += `<div style="display:flex; align-items:center; gap:12px; background:#f8fbff; padding:10px; border-radius:12px;">
                                <img src="${guru.Foto || ''}" style="width:50px; height:50px; border-radius:8px; object-fit:cover;">
                                <div><h4 style="font-size:14px;">${guru.Nama}</h4><p style="font-size:11px; color:gray;">${guru.Jabatan}</p></div>
                             </div>`;
                });
                document.getElementById('modalBody').innerHTML = html + '</div>';
            } catch (e) { document.getElementById('modalBody').innerHTML = 'Gagal memuat data.'; }
        }

        // --- NAVIGATION & UI LOGIC ---
        function showSection(id, el, direction = 'left') {
            const newIndex = sectionIds.indexOf(id);
            if (newIndex === currentTabIndex) return;
            const currentSection = document.querySelector('.section.active');
            const nextSection = document.getElementById(id);
            if (currentSection) {
                currentSection.classList.remove('active');
                currentSection.classList.add(direction === 'left' ? 'exit-left' : 'exit-right');
                setTimeout(() => currentSection.classList.remove('exit-left', 'exit-right'), 450);
            }
            nextSection.classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.swipe-dot').forEach((dot, i) => dot.classList.toggle('active', i === newIndex));
            currentTabIndex = newIndex;
        }

        function toggleSidebar() {
            const s = document.getElementById('sidebar');
            const o = document.getElementById('sidebarOverlay');
            const active = s.classList.toggle('active');
            o.style.display = active ? 'block' : 'none';
        }

        function openModal(title, content) {
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('contentModal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('contentModal').style.display = 'none'; }

        function openDynamicContent(key) { openModal(key, DYNAMIC_DATA[key] || "Konten tidak ditemukan."); }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2500);
        }

        function updateNetwork() {
            const online = navigator.onLine;
            const ns = document.getElementById('networkStatus');
            ns.className = 'profile-network ' + (online ? 'online' : 'offline');
            ns.innerHTML = `<i class="fa-solid fa-circle" style="font-size:7px;"></i> ${online ? 'Online' : 'Offline'}`;
        }

        function previewImage(event) {
            const reader = new FileReader();
            reader.onload = e => {
                localStorage.setItem('userProfileAvatar', e.target.result);
                updateAvatarUI(e.target.result);
            };
            reader.readAsDataURL(event.target.files[0]);
        }

        function updateAvatarUI(src) { document.getElementById('userAvatar').innerHTML = `<img src="${src}">`; }

        // --- EXAM SYSTEM (EXAMBRO) ---
        function openExamMenu() {
            openModal('Ujian (Exambro)', `
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <h4>Jadwal Ujian</h4>
                    <select id="selectHari" onchange="onHariChange()"><option value="">Pilih Hari</option></select>
                    <select id="selectKelas" disabled onchange="onKelasChange()"><option value="">Pilih Kelas</option></select>
                    <select id="selectMapel" disabled><option value="">Pilih Mata Pelajaran</option></select>
                    <button class="login-btn" onclick="startExam()">Mulai Ujian</button>
                    <p style="font-size: 9px">*hanya dapat diakses jika jadwal telah dimuat oleh panitia ujian</p>
                    <hr style="margin:15px 0; border: 0; border-top: 1px solid #eee;">
                    <h4>Ulangan Harian / Lainnya</h4>
                    <div id="qrScannerBox" style="display:none; margin-top:15px;"><div id="qrReader"></div></div>
                    <button class="login-btn" onclick="scanBarcode()"><i class="fa-solid fa-qrcode"></i> Scan Barcode</button>
                    <p style="text-align:center;">atau</p>
                    <input id="manualLink" type="text" placeholder="Input URL / Token Ujian">
                    <button class="login-btn" onclick="openManualLink()">Masuk Ujian</button>
                </div>
            `);
            if (ujianData.length === 0) { showToast('Memuat jadwal...'); setTimeout(populateHari, 500); } else { populateHari(); }
        }

        function populateHari() {
            const selectHari = document.getElementById('selectHari');
            selectHari.innerHTML = '<option value="">Pilih Hari</option>';
            ujianData.filter(d => d.JenisUjian === 'SAS').forEach(d => {
                const status = getExamStatus(d.Tanggal);
                const label = status === 'AKTIF' ? 'üü¢ AKTIF' : status === 'SUSULAN' ? 'üü° SUSULAN' : 'üî¥ BELUM';
                const opt = document.createElement('option');
                opt.value = d.Hari;
                opt.textContent = `${d.Hari} (${label})`;
                selectHari.appendChild(opt);
            });
        }

        function onHariChange() {
            const hari = document.getElementById('selectHari').value;
            const kSelect = document.getElementById('selectKelas');
            kSelect.disabled = !hari;
            kSelect.innerHTML = '<option value="">Pilih Kelas</option>';
            if (!hari) return;
            [...new Set(ujianData.filter(d => d.Hari === hari && d.JenisUjian === 'SAS').map(d => d.Kelas))].forEach(k => kSelect.innerHTML += `<option value="${k}">${k}</option>`);
        }

        function onKelasChange() {
            const hari = document.getElementById('selectHari').value;
            const kelas = document.getElementById('selectKelas').value;
            const mSelect = document.getElementById('selectMapel');
            mSelect.disabled = !kelas;
            mSelect.innerHTML = '<option value="">Pilih Mata Pelajaran</option>';
            if (!kelas) return;
            [...new Set(ujianData.filter(d => d.Hari === hari && d.Kelas === kelas && d.JenisUjian === 'SAS').map(d => d.Mapel))].forEach(m => mSelect.innerHTML += `<option value="${m}">${m}</option>`);
        }

        function startExam() {
            const hari = document.getElementById('selectHari').value;
            const kelas = document.getElementById('selectKelas').value;
            const mapel = document.getElementById('selectMapel').value;
            ujianAktif = ujianData.find(u => u.JenisUjian === 'SAS' && u.Hari === hari && u.Kelas === kelas && u.Mapel === mapel);
            if (!ujianAktif) return showToast('Data tidak ditemukan');
            if (getExamStatus(ujianAktif.Tanggal) === 'BELUM') return showToast('Belum dapat diakses');
            confirmExamStart();
        }

        function confirmExamStart() {
            openModal('PERINGATAN UJIAN', `
                <p><b>PERHATIAN!</b></p>
                    <p>Selama ujian berlangsung peserta:</p>
                    <ul style="padding-left:18px;">
                        <li>Dilarang meninggalkan halaman ujian</li>
                        <li>Dilarang screenshot atau rekam layar</li>
                        <li>Dilarang membuka aplikasi lain</li>
                        <li>Dilarang bekerjasama dengan peserta lain</li>
                        <li>Jika keluar, ujian dianggap selesai</li>
                        <li>Mematuhi tata terteib ujian lainya.</li>
                    </ul>
                <label style="display:flex; gap:8px; margin-top:10px;"><input type="checkbox" id="agreeExam"> Saya mengerti</label>
                <button class="login-btn" onclick="handleConfirmExam()">MULAI UJIAN</button>
            `);
        }

        function handleConfirmExam() {
            if (!document.getElementById('agreeExam').checked) return showToast('Centang persetujuan');
            if (!ujianAktif.LinkSoal) return alert('Link soal belum tersedia');
            closeModal();
            ujianSedangBerjalan = true;
            enterExamMode();
            setTimeout(() => { window.location.href = ujianAktif.LinkSoal; }, 300);
        }

        async function enterExamMode() {
            const el = document.documentElement;
            if (el.requestFullscreen) await el.requestFullscreen();
            if (screen.orientation && screen.orientation.lock) try { await screen.orientation.lock('portrait'); } catch (e) {}
        }

        function startExamTimer(durationMinutes) {
            if (examTimerInterval) clearInterval(examTimerInterval);
            const now = Date.now();
            examEndTime = localStorage.getItem('examEndTime') ? parseInt(localStorage.getItem('examEndTime')) : now + durationMinutes * 60 * 1000;
            localStorage.setItem('examEndTime', examEndTime);
            const timerEl = document.getElementById('examTimer');
            timerEl.style.display = 'block';
            examTimerInterval = setInterval(() => {
                const remaining = examEndTime - Date.now();
                if (remaining <= 0) { clearInterval(examTimerInterval); selesaiUjianKarenaWaktu(); return; }
                const min = Math.floor(remaining / 60000);
                const sec = Math.floor((remaining % 60000) / 1000);
                timerEl.textContent = `‚è±Ô∏è ${String(min).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
            }, 1000);
        }

        function selesaiUjianKarenaWaktu() { ujianSedangBerjalan = false; localStorage.removeItem('examEndTime'); alert('Waktu habis.'); location.reload(); }

async function scanBarcode() {
  const box = document.getElementById('qrScannerBox');
  box.style.display = 'block';

  if (html5Qr) {
    try {
      await html5Qr.stop();
      html5Qr.clear();
    } catch (e) {}
  }

  html5Qr = new Html5Qrcode("qrReader");

  html5Qr.start(
    { facingMode: "environment" }, // JANGAN pakai exact
    {
      fps: 10,
      qrbox: 220,
      rememberLastUsedCamera: true,
      supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA]
    },
    onQrSuccess,
    () => {}
  ).catch(err => {
    console.error(err);
    showToast("Kamera tidak tersedia / izin ditolak");
  });
}




         function onQrSuccess(qrText) {
            if (!qrText) return;

            showToast("QR terbaca");

            if (html5Qr) {
              html5Qr.stop().then(() => html5Qr.clear());
            }

            setTimeout(() => {
              ujianSedangBerjalan = true;
              enterExamMode();
              startExamTimer(60);
              window.location.href = qrText;
            }, 400);
          }



        function openManualLink() {
            const link = document.getElementById('manualLink').value;
            if (!link) return showToast('Masukkan link/token');
            ujianSedangBerjalan = true;
            enterExamMode();
            startExamTimer(60);
            window.location.href = link;
        }

        function getExamStatus(tanggal) {
            const today = new Date().toISOString().slice(0, 10);
            return tanggal === today ? 'AKTIF' : (tanggal < today ? 'SUSULAN' : 'BELUM');
        }

        // --- PENGUMUMAN & KELULUSAN ---
        function openPengumuman() {
            openModal('Pengumuman Kelulusan', `
                <p style="text-align: center; font-weight: bold;">UJI KOMPETENSI KEAHLIAN (UKK)</p>
                <input id="namaKelulusan" placeholder="Nama Lengkap">
                <input id="kelasKelulusan" placeholder="Kelas (Contoh: XII.1)">
                <button class="login-btn" onclick="cariKelulusan()">Cari</button>
                <div id="hasilKelulusan" style="margin-top:15px;"></div>
            `);
        }

        function cariKelulusan() {
            const nama = document.getElementById('namaKelulusan').value;
            const kelas = document.getElementById('kelasKelulusan').value;
            const box = document.getElementById('hasilKelulusan');
            if (!nama || !kelas) return showToast('Data wajib diisi');
            box.innerHTML = '‚è≥ Memeriksa...';
            const cb = 'cb_' + Date.now();
            window[cb] = function(data) {
                delete window[cb]; script.remove();
                if (data.locked) { box.innerHTML = `üîí Dibuka pada <b>${data.buka}</b>`; return; }
                if (!data.found) { box.innerHTML = '<p style="color:red;">Tidak ditemukan</p>'; return; }
                const warna = data.status === 'LULUS' ? '#16a34a' : '#dc2626';
                if (data.status === 'LULUS') launchConfetti();
                box.innerHTML = `<div class="${data.status === 'LULUS' ? 'lulus-box' : ''}" style="border:2px solid ${warna};padding:16px;border-radius:16px">
                                    <h2 style="color:${warna}">${data.status}</h2>
                                    <p><b>Nama:</b> ${data.nama}</p><p><b>Kelas:</b> ${data.kelas}</p><p>${data.keterangan}</p>
                                 </div>`;
                if (data.video && data.status === 'LULUS') {
                    const embed = data.video.replace('watch?v=', 'embed/') + '?autoplay=1&mute=1';
                    box.innerHTML += `<iframe src="${embed}" width="100%" height="220" style="margin-top:14px;border-radius:14px" allow="autoplay" allowfullscreen></iframe>`;
                }
            };
            const script = document.createElement('script');
            script.src = `${KELULUSAN_API}?nama=${encodeURIComponent(nama)}&kelas=${encodeURIComponent(kelas)}&callback=${cb}`;
            document.body.appendChild(script);
        }

        function launchConfetti() {
            for (let i = 0; i < 80; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random() * 100 + 'vw';
                c.style.backgroundColor = `hsl(${Math.random()*360},90%,60%)`;
                c.style.animationDuration = (Math.random() * 2 + 2) + 's';
                document.body.appendChild(c);
                setTimeout(() => c.remove(), 4000);
            }
        }

        // --- GESTURE & EVENTS ---
        let startX = 0;
        document.addEventListener('touchstart', e => { startX = e.touches[0].clientX; }, { passive: true });
        document.addEventListener('touchend', e => {
            const dx = e.changedTouches[0].clientX - startX;
            if (Math.abs(dx) < 70) return;
            if (dx < 0 && currentTabIndex < sectionIds.length - 1) {
                const n = currentTabIndex + 1;
                showSection(sectionIds[n], document.querySelectorAll('.nav-item')[n], 'left');
            } else if (dx > 0 && currentTabIndex > 0) {
                const p = currentTabIndex - 1;
                showSection(sectionIds[p], document.querySelectorAll('.nav-item')[p], 'right');
            }
        });

        document.addEventListener('visibilitychange', () => { if (ujianSedangBerjalan && document.hidden) alert('Dilarang berpindah aplikasi!'); });
        document.addEventListener('contextmenu', e => { if (ujianSedangBerjalan) e.preventDefault(); });

        // --- PWA INSTALL LOGIC ---
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const btn = document.getElementById('btnInstall');
            if (btn) btn.style.display = 'block';
        });

        document.getElementById('btnInstall')?.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            await deferredPrompt.userChoice;
            deferredPrompt = null;
            document.getElementById('btnInstall').style.display = 'none';
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => { initApp(); fetchJadwalUjian(); });
        window.addEventListener('online', () => { updateNetwork(); showToast('Kembali Online'); });
        window.addEventListener('offline', () => { updateNetwork(); showToast('Mode Offline'); });
    </script>
</body>
</html>